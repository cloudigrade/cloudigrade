---
apiVersion: v1
kind: Template
metadata:
  name: cloudigrade
objects:
- apiVersion: v1
  kind: Secret # For ephemeral/local environment
  metadata:
    name: cloudigrade-secrets
    labels:
      app: cloudigrade
  stringData:
    encryption-key: "${ENCRYPTION_KEY}"
    secret-key: "${SECRET_KEY}"
- apiVersion: cloud.redhat.com/v1alpha1
  kind: ClowdApp
  metadata:
    name: cloudigrade
  spec:
    envName: ${ENV_NAME}
    deployments:
    - name: api
      #
      # Component cloudigrade-api deployment:
      #
      minReplicas: ${{MIN_REPLICAS}}
      webServices:
        public:
          enabled: true # port 8000 is the default in CloudEnvironment
      podSpec:
        image: ${IMAGE}:${IMAGE_TAG}
        env:
        - name: APP_NAME
          value: ${APP_NAME}
        - name: ENV_NAME
          value: ${ENV_NAME}
        - name: ENCRYPTION_KEY
          value: ${ENCRYPTION_KEY}
        - name: SECRET_KEY_BASE
          value: ${SECRET_KEY_BASE}
        - name: ANALYZE_LOG_SCHEDULE
          value: ${ANALYZE_LOG_SCHEDULE}
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              key: aws-access-key-id
              name: cloudigrade
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: aws-secret-access-key
              name: cloudigrade
        - name: AWS_DEFAULT_REGION
          value: ${AWS_DEFAULT_REGION}
        - name: AWS_SQS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              key: aws-sqs-access-key-id
              name: cloudigrade
        - name: AWS_SQS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: aws-sqs-secret-access-key
              name: cloudigrade
        - name: AWS_SQS_REGION
          value: ${AWS_SQS_REGION}
        - name: AWS_SQS_MAX_RECEIVE_COUNT
          value: ${AWS_SQS_MAX_RECEIVE_COUNT}
        - name: AWS_SQS_MAX_YIELD_COUNT
          value: ${AWS_SQS_MAX_YIELD_COUNT}
        - name: AWS_SQS_MAX_HOUNDI_YIELD_COUNT
          value: ${AWS_SQS_MAX_HOUNDI_YIELD_COUNT}
        - name: S3_BUCKET_LC_NAME
          value: ${S3_BUCKET_LC_NAME}
        - name: S3_BUCKET_LC_IA_TRANSITION
          value: ${S3_BUCKET_LC_IA_TRANSITION}
        - name: S3_BUCKET_LC_GLACIER_TRANSITION
          value: ${S3_BUCKET_LC_GLACIER_TRANSITION}
        - name: S3_BUCKET_LC_MAX_AGE
          value: ${S3_BUCKET_LC_MAX_AGE}
        - name: DJANGO_SETTINGS_MODULE
          value: ${DJANGO_SETTINGS_MODULE}
        - name: DJANGO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: django-secret-key
              name: cloudigrade
        - name: DJANGO_ALLOWED_HOSTS
          value: ${DJANGO_ALLOWED_HOSTS}
        - name: DJANGO_DATABASE_CONN_MAX_AGE
          value: ${DJANGO_DATABASE_CONN_MAX_AGE}
        - name: DJANGO_DATABASE_NAME
          value: ${DJANGO_DATABASE_NAME}
        - name: DJANGO_DATABASE_PORT
          value: ${DJANGO_DATABASE_PORT}
        - name: DJANGO_DATABASE_HOST
          value: ${DJANGO_DATABASE_HOST}
        - name: DJANGO_DATABASE_USER
          value: ${DJANGO_DATABASE_USER}
        - name: DJANGO_DATABASE_PASSWORD
          value: ${DJANGO_DATABASE_PASSWORD}
        - name: DJANGO_DEBUG
          value: ${DJANGO_DEBUG}
        - name: DJANGO_LOG_LEVEL
          value: ${DJANGO_LOG_LEVEL}
        - name: DJANGO_ALL_LOG_LEVEL
          value: ${DJANGO_ALL_LOG_LEVEL}
        - name: DJANGO_CONSOLE_LOG_LEVEL
          value: ${DJANGO_CONSOLE_LOG_LEVEL}
        - name: CLOUDIGRADE_LOG_LEVEL
          value: ${CLOUDIGRADE_LOG_LEVEL}
        - name: SCHEDULE_CONCURRENT_USAGE_CALCULATION_DELAY
          value: ${SCHEDULE_CONCURRENT_USAGE_CALCULATION_DELAY}
        - name: SCHEDULE_VERIFY_VERIFY_TASKS_INTERVAL
          value: ${SCHEDULE_VERIFY_VERIFY_TASKS_INTERVAL}
        - name: HOUNDIGRADE_ECS_IMAGE_NAME
          value: ${HOUNDIGRADE_ECS_IMAGE_NAME}
        - name: HOUNDIGRADE_ECS_IMAGE_TAG
          value: ${HOUNDIGRADE_ECS_IMAGE_TAG}
        - name: HOUNDIGRADE_ECS_FAMILY_NAME
          value: ${HOUNDIGRADE_ECS_FAMILY_NAME}
        - name: INSPECTION_CLUSTER_INSTANCE_AGE_LIMIT
          value: ${INSPECTION_CLUSTER_INSTANCE_AGE_LIMIT}
        - name: CLOUDIGRADE_VERSION
          value: ${CLOUDIGRADE_VERSION}
        - name: CLOUDIGRADE_ENVIRONMENT
          value: ${CLOUDIGRADE_ENVIRONMENT}
        - name: SENTRY_TRACES_SAMPLE_RATE
          value: ${SENTRY_TRACES_SAMPLE_RATE}
        - name: API_ENABLE_SENTRY
          value: ${API_ENABLE_SENTRY}
        - name: DJANGO_SENTRY_DSN
          valueFrom:
            secretKeyRef:
              key: api-sentry-dsn
              name: cloudigrade
        - name: DJANGO_SENTRY_ENVIRONMENT
          value: ${DJANGO_SENTRY_ENVIRONMENT}
        - name: HOUNDIGRADE_ENABLE_SENTRY
          value: ${HOUNDIGRADE_ENABLE_SENTRY}
        - name: HOUNDIGRADE_SENTRY_DSN
          valueFrom:
            secretKeyRef:
              key: houndigrade-sentry-dsn
              name: cloudigrade
        - name: HOUNDIGRADE_SENTRY_RELEASE
          value: ${HOUNDIGRADE_SENTRY_RELEASE}
        - name: HOUNDIGRADE_SENTRY_ENVIRONMENT
          value: ${HOUNDIGRADE_SENTRY_ENVIRONMENT}
        - name: SOURCES_ENABLE_DATA_MANAGEMENT_FROM_KAFKA
          value: ${SOURCES_ENABLE_DATA_MANAGEMENT_FROM_KAFKA}
        - name: SOURCES_API_BASE_URL
          value: ${SOURCES_API_BASE_URL}
        - name: CLOUDIGRADE_ENABLE_CLOUDWATCH
          value: ${CLOUDIGRADE_ENABLE_CLOUDWATCH}
        - name: CW_AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              key: aws_access_key_id
              name: cloudwatch
        - name: CW_AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: aws_secret_access_key
              name: cloudwatch
        - name: CW_AWS_REGION_NAME
          valueFrom:
            secretKeyRef:
              key: aws_region
              name: cloudwatch
        - name: CLOUDIGRADE_CW_LEVEL
          value: ${CLOUDIGRADE_CW_LEVEL}
        - name: CLOUDIGRADE_CW_LOG_GROUP
          valueFrom:
            secretKeyRef:
              key: log_group_name
              name: cloudwatch
        - name: CLOUDIGRADE_CW_STREAM_NAME
          value: ${CLOUDIGRADE_CW_STREAM_NAME}
        - name: LISTENER_LOG_LEVEL
          value: ${LISTENER_LOG_LEVEL}
        - name: LISTENER_TOPIC
          value: ${LISTENER_TOPIC}
        - name: LISTENER_GROUP_ID
          value: ${LISTENER_GROUP_ID}
        - name: LISTENER_SERVER
          value: ${LISTENER_SERVER}
        - name: LISTENER_PORT
          value: ${LISTENER_PORT}
        - name: VERBOSE_INSIGHTS_IDENTITY_HEADER_LOGGING
          value: ${VERBOSE_INSIGHTS_IDENTITY_HEADER_LOGGING}
        - name: VERBOSE_SOURCES_NOTIFICATION_LOGGING
          value: ${VERBOSE_SOURCES_NOTIFICATION_LOGGING}
        - name: CACHE_TTL_DEFAULT
          value: ${CACHE_TTL_DEFAULT}
        - name: CACHE_TTL_SOURCES_APPLICATION_TYPE_ID
          value: ${CACHE_TTL_SOURCES_APPLICATION_TYPE_ID}
        - name: OSD_REDEPLOY_TRIGGER
          value: ${OSD_REDEPLOY_TRIGGER}
        - name: IMAGE_TAG
          value: ${IMAGE_TAG}
        - name: SLACK_TOKEN
          valueFrom:
            secretKeyRef:
              key: slack-token
              name: cloudigrade
        - name: HABERDASHER_EMITTER
          value: ${HABERDASHER_EMITTER}
        - name: HABERDASHER_KAFKA_BOOTSTRAP
          value: ${HABERDASHER_KAFKA_BOOTSTRAP}
        - name: HABERDASHER_KAFKA_TOPIC
          value: ${HABERDASHER_KAFKA_TOPIC}
        - name: HABERDASHER_LABELS
          value: ${HABERDASHER_LABELS}
        - name: HABERDASHER_TAGS
          value: ${HABERDASHER_TAGS}
        - name: WATCHTOWER_USE_QUEUES
          value: ${WATCHTOWER_USE_QUEUES}
        - name: WATCHTOWER_SEND_INTERVAL
          value: ${WATCHTOWER_SEND_INTERVAL}
        - name: WATCHTOWER_MAX_BATCH_COUNT
          value: ${WATCHTOWER_MAX_BATCH_COUNT}
        livenessProbe:
          exec:
            command:
              - /bin/sh
              - -c
              - 'ps axo command | grep -v grep | grep gunicorn'
          failureThreshold: 3
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        readinessProbe:
          failureThreshold: 3
          httpGet:
            path: /internal/healthz/
            port: 8000
            scheme: HTTP
            httpHeaders:
              - name: Host
                value: ${HEALTH_CHECK_HOST_HEADER}
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        resources:
          limits:
            cpu: 200m
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 500Mi
    - name: beat
      #
      # Component cloudigrade-beat deployment:
      #
      replicas: ${{CELERY_BEAT_REPLICA_COUNT}}
      webServices:
        public:
          enabled: false
      podSpec:
        image: ${IMAGE}:${IMAGE_TAG}
        env:
        - name: ANALYZE_LOG_SCHEDULE
          value: ${ANALYZE_LOG_SCHEDULE}
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              key: aws-access-key-id
              name: cloudigrade
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: aws-secret-access-key
              name: cloudigrade
        - name: AWS_DEFAULT_REGION
          value: ${AWS_DEFAULT_REGION}
        - name: AWS_SQS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              key: aws-sqs-access-key-id
              name: cloudigrade
        - name: AWS_SQS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: aws-sqs-secret-access-key
              name: cloudigrade
        - name: AWS_SQS_REGION
          value: ${AWS_SQS_REGION}
        - name: AWS_SQS_MAX_RECEIVE_COUNT
          value: ${AWS_SQS_MAX_RECEIVE_COUNT}
        - name: AWS_SQS_MAX_YIELD_COUNT
          value: ${AWS_SQS_MAX_YIELD_COUNT}
        - name: AWS_SQS_MAX_HOUNDI_YIELD_COUNT
          value: ${AWS_SQS_MAX_HOUNDI_YIELD_COUNT}
        - name: S3_BUCKET_LC_NAME
          value: ${S3_BUCKET_LC_NAME}
        - name: S3_BUCKET_LC_IA_TRANSITION
          value: ${S3_BUCKET_LC_IA_TRANSITION}
        - name: S3_BUCKET_LC_GLACIER_TRANSITION
          value: ${S3_BUCKET_LC_GLACIER_TRANSITION}
        - name: S3_BUCKET_LC_MAX_AGE
          value: ${S3_BUCKET_LC_MAX_AGE}
        - name: DJANGO_SETTINGS_MODULE
          value: ${DJANGO_SETTINGS_MODULE}
        - name: DJANGO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: django-secret-key
              name: cloudigrade
        - name: DJANGO_ALLOWED_HOSTS
          value: ${DJANGO_ALLOWED_HOSTS}
        - name: DJANGO_DATABASE_CONN_MAX_AGE
          value: ${DJANGO_DATABASE_CONN_MAX_AGE}
        - name: DJANGO_DATABASE_NAME
          value: ${DJANGO_DATABASE_NAME}
        - name: DJANGO_DATABASE_PORT
          value: ${DJANGO_DATABASE_PORT}
        - name: DJANGO_DATABASE_HOST
          value: ${DJANGO_DATABASE_HOST}
        - name: DJANGO_DATABASE_USER
          value: ${DJANGO_DATABASE_USER}
        - name: DJANGO_DATABASE_PASSWORD
          value: ${DJANGO_DATABASE_PASSWORD}
        - name: DJANGO_DEBUG
          value: ${DJANGO_DEBUG}
        - name: DJANGO_LOG_LEVEL
          value: ${DJANGO_LOG_LEVEL}
        - name: DJANGO_ALL_LOG_LEVEL
          value: ${DJANGO_ALL_LOG_LEVEL}
        - name: CLOUDIGRADE_LOG_LEVEL
          value: ${CLOUDIGRADE_LOG_LEVEL}
        - name: SCHEDULE_CONCURRENT_USAGE_CALCULATION_DELAY
          value: ${SCHEDULE_CONCURRENT_USAGE_CALCULATION_DELAY}
        - name: DJANGO_CONSOLE_LOG_LEVEL
          value: ${DJANGO_CONSOLE_LOG_LEVEL}
        - name: SCHEDULE_VERIFY_VERIFY_TASKS_INTERVAL
          value: ${SCHEDULE_VERIFY_VERIFY_TASKS_INTERVAL}
        - name: HOUNDIGRADE_ECS_IMAGE_NAME
          value: ${HOUNDIGRADE_ECS_IMAGE_NAME}
        - name: HOUNDIGRADE_ECS_IMAGE_TAG
          value: ${HOUNDIGRADE_ECS_IMAGE_TAG}
        - name: HOUNDIGRADE_ECS_FAMILY_NAME
          value: ${HOUNDIGRADE_ECS_FAMILY_NAME}
        - name: INSPECT_PENDING_IMAGES_MIN_AGE
          value: ${INSPECT_PENDING_IMAGES_MIN_AGE}
        - name: INSPECT_PENDING_IMAGES_SCHEDULE
          value: ${INSPECT_PENDING_IMAGES_SCHEDULE}
        - name: INSPECTION_CLUSTER_INSTANCE_AGE_LIMIT
          value: ${INSPECTION_CLUSTER_INSTANCE_AGE_LIMIT}
        - name: HOUNDIGRADE_ECS_SCALE_UP_CLUSTER_SCHEDULE
          value: ${HOUNDIGRADE_ECS_SCALE_UP_CLUSTER_SCHEDULE}
        - name: HOUNDIGRADE_ECS_PERSIST_INSPECTION_RESULTS_SCHEDULE
          value: ${HOUNDIGRADE_ECS_PERSIST_INSPECTION_RESULTS_SCHEDULE}
        - name: AWS_REPOPULATE_EC2_INSTANCE_MAPPING_SCHEDULE
          value: ${AWS_REPOPULATE_EC2_INSTANCE_MAPPING_SCHEDULE}
        - name: CLOUDIGRADE_VERSION
          value: ${CLOUDIGRADE_VERSION}
        - name: CLOUDIGRADE_ENVIRONMENT
          value: ${CLOUDIGRADE_ENVIRONMENT}
        - name: SENTRY_TRACES_SAMPLE_RATE
          value: ${SENTRY_TRACES_SAMPLE_RATE}
        - name: CELERY_ENABLE_SENTRY
          value: ${CELERY_ENABLE_SENTRY}
        - name: CELERY_SENTRY_DSN
          value: ${CELERY_SENTRY_DSN}
        - name: CELERY_SENTRY_RELEASE
          value: ${CELERY_SENTRY_RELEASE}
        - name: CELERY_SENTRY_ENVIRONMENT
          value: ${CELERY_SENTRY_ENVIRONMENT}
        - name: SOURCES_ENABLE_DATA_MANAGEMENT_FROM_KAFKA
          value: ${SOURCES_ENABLE_DATA_MANAGEMENT_FROM_KAFKA}
        - name: SOURCES_API_BASE_URL
          value: ${SOURCES_API_BASE_URL}
        - name: CLOUDIGRADE_ENABLE_CLOUDWATCH
          value: ${CLOUDIGRADE_ENABLE_CLOUDWATCH}
        - name: CW_AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              key: aws_access_key_id
              name: cloudwatch
        - name: CW_AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: aws_secret_access_key
              name: cloudwatch
        - name: CW_AWS_REGION_NAME
          valueFrom:
            secretKeyRef:
              key: aws_region
              name: cloudwatch
        - name: CLOUDIGRADE_CW_LEVEL
          value: ${CLOUDIGRADE_CW_LEVEL}
        - name: CLOUDIGRADE_CW_LOG_GROUP
          valueFrom:
            secretKeyRef:
              key: log_group_name
              name: cloudwatch
        - name: CLOUDIGRADE_CW_STREAM_NAME
          value: ${CLOUDIGRADE_CW_STREAM_NAME}
        - name: OSD_REDEPLOY_TRIGGER
          value: ${OSD_REDEPLOY_TRIGGER}
        - name: IMAGE_TAG
          value: ${IMAGE_TAG}
        - name: HABERDASHER_EMITTER
          value: ${HABERDASHER_EMITTER}
        - name: HABERDASHER_KAFKA_BOOTSTRAP
          value: ${HABERDASHER_KAFKA_BOOTSTRAP}
        - name: HABERDASHER_KAFKA_TOPIC
          value: ${HABERDASHER_KAFKA_TOPIC}
        - name: HABERDASHER_LABELS
          value: ${HABERDASHER_LABELS}
        - name: HABERDASHER_TAGS
          value: ${HABERDASHER_TAGS}
        - name: VERBOSE_SOURCES_NOTIFICATION_LOGGING
          value: ${VERBOSE_SOURCES_NOTIFICATION_LOGGING}
        - name: CACHE_TTL_DEFAULT
          value: ${CACHE_TTL_DEFAULT}
        - name: CACHE_TTL_SOURCES_APPLICATION_TYPE_ID
          value: ${CACHE_TTL_SOURCES_APPLICATION_TYPE_ID}
        - name: WATCHTOWER_USE_QUEUES
          value: ${WATCHTOWER_USE_QUEUES}
        - name: WATCHTOWER_SEND_INTERVAL
          value: ${WATCHTOWER_SEND_INTERVAL}
        - name: WATCHTOWER_MAX_BATCH_COUNT
          value: ${WATCHTOWER_MAX_BATCH_COUNT}
        command:
          - /bin/sh
          - -c
          - >
            celery
            --app config
            beat
            --loglevel info
            --pidfile=
            --scheduler django_celery_beat.schedulers:DatabaseScheduler
        resources:
          requests:
            cpu: ${CELERY_BEAT_LIMITS_CONTAINER_CPU_REQUEST}
            memory: ${CELERY_BEAT_LIMITS_CONTAINER_MEM_REQUEST}
          limits:
            cpu: ${CELERY_BEAT_LIMITS_CONTAINER_CPU_LIMIT}
            memory: ${CELERY_BEAT_LIMITS_CONTAINER_MEM_LIMIT}
        livenessProbe:
          exec:
            command:
              - /bin/sh
              - -c
              - 'ps axo command | grep -v grep | grep python'
          failureThreshold: 3
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        readinessProbe:
          exec:
            command:
              - /bin/sh
              - -c
              - '[[ $(ps axo command | grep "[p]ython" | grep celery | grep -c beat) -eq 1 ]]'
          failureThreshold: 3
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
    - name: listener
      #
      # Component cloudigrade-listener deployment:
      #
      replicas: ${{LISTENER_WORKER_REPLICA_COUNT}}
      webServices:
        public:
          enabled: false
      podSpec:
        image: ${IMAGE}:${IMAGE_TAG}
        env:
        - name: LISTENER_LOG_LEVEL
          value: ${LISTENER_LOG_LEVEL}
        - name: LISTENER_TOPIC
          value: ${LISTENER_TOPIC}
        - name: LISTENER_GROUP_ID
          value: ${LISTENER_GROUP_ID}
        - name: LISTENER_SERVER
          value: ${LISTENER_SERVER}
        - name: LISTENER_PORT
          value: ${LISTENER_PORT}
        - name: SOURCES_ENABLE_DATA_MANAGEMENT_FROM_KAFKA
          value: ${SOURCES_ENABLE_DATA_MANAGEMENT_FROM_KAFKA}
        - name: SOURCES_API_BASE_URL
          value: ${SOURCES_API_BASE_URL}
        - name: SENTRY_TRACES_SAMPLE_RATE
          value: ${SENTRY_TRACES_SAMPLE_RATE}
        - name: CELERY_ENABLE_SENTRY
          value: ${CELERY_ENABLE_SENTRY}
        - name: CELERY_SENTRY_DSN
          value: ${CELERY_SENTRY_DSN}
        - name: CELERY_SENTRY_ENVIRONMENT
          value: ${CELERY_SENTRY_ENVIRONMENT}
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              key: aws-access-key-id
              name: cloudigrade
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: aws-secret-access-key
              name: cloudigrade
        - name: AWS_DEFAULT_REGION
          value: ${AWS_DEFAULT_REGION}
        - name: AWS_SQS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              key: aws-sqs-access-key-id
              name: cloudigrade
        - name: AWS_SQS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: aws-sqs-secret-access-key
              name: cloudigrade
        - name: AWS_SQS_REGION
          value: ${AWS_SQS_REGION}
        - name: AWS_SQS_MAX_RECEIVE_COUNT
          value: ${AWS_SQS_MAX_RECEIVE_COUNT}
        - name: AWS_SQS_MAX_YIELD_COUNT
          value: ${AWS_SQS_MAX_YIELD_COUNT}
        - name: AWS_SQS_MAX_HOUNDI_YIELD_COUNT
          value: ${AWS_SQS_MAX_HOUNDI_YIELD_COUNT}
        - name: S3_BUCKET_LC_NAME
          value: ${S3_BUCKET_LC_NAME}
        - name: S3_BUCKET_LC_IA_TRANSITION
          value: ${S3_BUCKET_LC_IA_TRANSITION}
        - name: S3_BUCKET_LC_GLACIER_TRANSITION
          value: ${S3_BUCKET_LC_GLACIER_TRANSITION}
        - name: S3_BUCKET_LC_MAX_AGE
          value: ${S3_BUCKET_LC_MAX_AGE}
        - name: DJANGO_SETTINGS_MODULE
          value: ${DJANGO_SETTINGS_MODULE}
        - name: DJANGO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: django-secret-key
              name: cloudigrade
        - name: DJANGO_ALLOWED_HOSTS
          value: ${DJANGO_ALLOWED_HOSTS}
        - name: DJANGO_DATABASE_CONN_MAX_AGE
          value: ${DJANGO_DATABASE_CONN_MAX_AGE}
        - name: DJANGO_DATABASE_NAME
          value: ${DJANGO_DATABASE_NAME}
        - name: DJANGO_DATABASE_PORT
          value: ${DJANGO_DATABASE_PORT}
        - name: DJANGO_DATABASE_HOST
          value: ${DJANGO_DATABASE_HOST}
        - name: DJANGO_DATABASE_USER
          value: ${DJANGO_DATABASE_USER}
        - name: DJANGO_DATABASE_PASSWORD
          value: ${DJANGO_DATABASE_PASSWORD}
        - name: DJANGO_DEBUG
          value: ${DJANGO_DEBUG}
        - name: DJANGO_LOG_LEVEL
          value: ${DJANGO_LOG_LEVEL}
        - name: DJANGO_ALL_LOG_LEVEL
          value: ${DJANGO_ALL_LOG_LEVEL}
        - name: DJANGO_CONSOLE_LOG_LEVEL
          value: ${DJANGO_CONSOLE_LOG_LEVEL}
        - name: CLOUDIGRADE_LOG_LEVEL
          value: ${CLOUDIGRADE_LOG_LEVEL}
        - name: SCHEDULE_CONCURRENT_USAGE_CALCULATION_DELAY
          value: ${SCHEDULE_CONCURRENT_USAGE_CALCULATION_DELAY}
        - name: SCHEDULE_VERIFY_VERIFY_TASKS_INTERVAL
          value: ${SCHEDULE_VERIFY_VERIFY_TASKS_INTERVAL}
        - name: HOUNDIGRADE_ECS_IMAGE_NAME
          value: ${HOUNDIGRADE_ECS_IMAGE_NAME}
        - name: HOUNDIGRADE_ECS_IMAGE_TAG
          value: ${HOUNDIGRADE_ECS_IMAGE_TAG}
        - name: HOUNDIGRADE_ECS_FAMILY_NAME
          value: ${HOUNDIGRADE_ECS_FAMILY_NAME}
        - name: INSPECT_PENDING_IMAGES_MIN_AGE
          value: ${INSPECT_PENDING_IMAGES_MIN_AGE}
        - name: INSPECT_PENDING_IMAGES_SCHEDULE
          value: ${INSPECT_PENDING_IMAGES_SCHEDULE}
        - name: INSPECTION_CLUSTER_INSTANCE_AGE_LIMIT
          value: ${INSPECTION_CLUSTER_INSTANCE_AGE_LIMIT}
        - name: HOUNDIGRADE_ECS_SCALE_UP_CLUSTER_SCHEDULE
          value: ${HOUNDIGRADE_ECS_SCALE_UP_CLUSTER_SCHEDULE}
        - name: HOUNDIGRADE_ECS_PERSIST_INSPECTION_RESULTS_SCHEDULE
          value: ${HOUNDIGRADE_ECS_PERSIST_INSPECTION_RESULTS_SCHEDULE}
        - name: AWS_REPOPULATE_EC2_INSTANCE_MAPPING_SCHEDULE
          value: ${AWS_REPOPULATE_EC2_INSTANCE_MAPPING_SCHEDULE}
        - name: CLOUDIGRADE_VERSION
          value: ${CLOUDIGRADE_VERSION}
        - name: CLOUDIGRADE_ENVIRONMENT
          value: ${CLOUDIGRADE_ENVIRONMENT}
        - name: CLOUDIGRADE_ENABLE_CLOUDWATCH
          value: ${CLOUDIGRADE_ENABLE_CLOUDWATCH}
        - name: CW_AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              key: aws_access_key_id
              name: cloudwatch
        - name: CW_AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: aws_secret_access_key
              name: cloudwatch
        - name: CW_AWS_REGION_NAME
          valueFrom:
            secretKeyRef:
              key: aws_region
              name: cloudwatch
        - name: CLOUDIGRADE_CW_LEVEL
          value: ${CLOUDIGRADE_CW_LEVEL}
        - name: CLOUDIGRADE_CW_LOG_GROUP
          valueFrom:
            secretKeyRef:
              key: log_group_name
              name: cloudwatch
        - name: CLOUDIGRADE_CW_STREAM_NAME
          value: ${CLOUDIGRADE_CW_STREAM_NAME}
        - name: OSD_REDEPLOY_TRIGGER
          value: ${OSD_REDEPLOY_TRIGGER}
        - name: IMAGE_TAG
          value: ${IMAGE_TAG}
        - name: HABERDASHER_EMITTER
          value: ${HABERDASHER_EMITTER}
        - name: HABERDASHER_KAFKA_BOOTSTRAP
          value: ${HABERDASHER_KAFKA_BOOTSTRAP}
        - name: HABERDASHER_KAFKA_TOPIC
          value: ${HABERDASHER_KAFKA_TOPIC}
        - name: HABERDASHER_LABELS
          value: ${HABERDASHER_LABELS}
        - name: HABERDASHER_TAGS
          value: ${HABERDASHER_TAGS}
        - name: VERBOSE_SOURCES_NOTIFICATION_LOGGING
          value: ${VERBOSE_SOURCES_NOTIFICATION_LOGGING}
        - name: CACHE_TTL_DEFAULT
          value: ${CACHE_TTL_DEFAULT}
        - name: CACHE_TTL_SOURCES_APPLICATION_TYPE_ID
          value: ${CACHE_TTL_SOURCES_APPLICATION_TYPE_ID}
        - name: WATCHTOWER_USE_QUEUES
          value: ${WATCHTOWER_USE_QUEUES}
        - name: WATCHTOWER_SEND_INTERVAL
          value: ${WATCHTOWER_SEND_INTERVAL}
        - name: WATCHTOWER_MAX_BATCH_COUNT
          value: ${WATCHTOWER_MAX_BATCH_COUNT}
        livenessProbe:
          exec:
            command:
              - /bin/sh
              - -c
              - '[[ $(ps axo command | grep "^python" | grep "./manage.py" | grep -c "listen_to_sources") -eq 1 ]]'
          failureThreshold: 3
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        readinessProbe:
          exec:
            command:
              - /bin/sh
              - -c
              - '[[ $(ps axo command | grep "^python" | grep "./manage.py" | grep -c "listen_to_sources") -eq 1 ]]'
          failureThreshold: 3
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        volumeMounts:
        - mountPath: /var/run/cloudigrade
          name: cloudigrade-socket
      volumes:
      - name: cloudigrade-socket
        emptyDir: {}
    - name: worker
      #
      # Component cloudigrade-worker deployment:
      #
      replicas: ${{CELERY_WORKER_REPLICA_COUNT}}
      webServices:
        public:
          enabled: false
      podSpec:
        image: ${IMAGE}:${IMAGE_TAG}
        env:
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              key: aws-access-key-id
              name: cloudigrade
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: aws-secret-access-key
              name: cloudigrade
        - name: AWS_DEFAULT_REGION
          value: ${AWS_DEFAULT_REGION}
        - name: AWS_SQS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              key: aws-sqs-access-key-id
              name: cloudigrade
        - name: AWS_SQS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: aws-sqs-secret-access-key
              name: cloudigrade
        - name: AWS_SQS_REGION
          value: ${AWS_SQS_REGION}
        - name: AWS_SQS_MAX_RECEIVE_COUNT
          value: ${AWS_SQS_MAX_RECEIVE_COUNT}
        - name: AWS_SQS_MAX_YIELD_COUNT
          value: ${AWS_SQS_MAX_YIELD_COUNT}
        - name: AWS_SQS_MAX_HOUNDI_YIELD_COUNT
          value: ${AWS_SQS_MAX_HOUNDI_YIELD_COUNT}
        - name: S3_BUCKET_LC_NAME
          value: ${S3_BUCKET_LC_NAME}
        - name: S3_BUCKET_LC_IA_TRANSITION
          value: ${S3_BUCKET_LC_IA_TRANSITION}
        - name: S3_BUCKET_LC_GLACIER_TRANSITION
          value: ${S3_BUCKET_LC_GLACIER_TRANSITION}
        - name: S3_BUCKET_LC_MAX_AGE
          value: ${S3_BUCKET_LC_MAX_AGE}
        - name: DJANGO_SETTINGS_MODULE
          value: ${DJANGO_SETTINGS_MODULE}
        - name: DJANGO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: django-secret-key
              name: cloudigrade
        - name: DJANGO_ALLOWED_HOSTS
          value: ${DJANGO_ALLOWED_HOSTS}
        - name: DJANGO_DATABASE_CONN_MAX_AGE
          value: ${DJANGO_DATABASE_CONN_MAX_AGE}
        - name: DJANGO_DATABASE_NAME
          value: ${DJANGO_DATABASE_NAME}
        - name: DJANGO_DATABASE_PORT
          value: ${DJANGO_DATABASE_PORT}
        - name: DJANGO_DATABASE_HOST
          value: ${DJANGO_DATABASE_HOST}
        - name: DJANGO_DATABASE_USER
          value: ${DJANGO_DATABASE_USER}
        - name: DJANGO_DATABASE_PASSWORD
          value: ${DJANGO_DATABASE_PASSWORD}
        - name: DJANGO_DEBUG
          value: ${DJANGO_DEBUG}
        - name: DJANGO_LOG_LEVEL
          value: ${DJANGO_LOG_LEVEL}
        - name: DJANGO_ALL_LOG_LEVEL
          value: ${DJANGO_ALL_LOG_LEVEL}
        - name: DJANGO_CONSOLE_LOG_LEVEL
          value: ${DJANGO_CONSOLE_LOG_LEVEL}
        - name: CLOUDIGRADE_LOG_LEVEL
          value: ${CLOUDIGRADE_LOG_LEVEL}
        - name: SCHEDULE_CONCURRENT_USAGE_CALCULATION_DELAY
          value: ${SCHEDULE_CONCURRENT_USAGE_CALCULATION_DELAY}
        - name: SCHEDULE_VERIFY_VERIFY_TASKS_INTERVAL
          value: ${SCHEDULE_VERIFY_VERIFY_TASKS_INTERVAL}
        - name: HOUNDIGRADE_ECS_IMAGE_NAME
          value: ${HOUNDIGRADE_ECS_IMAGE_NAME}
        - name: HOUNDIGRADE_ECS_IMAGE_TAG
          value: ${HOUNDIGRADE_ECS_IMAGE_TAG}
        - name: HOUNDIGRADE_ECS_FAMILY_NAME
          value: ${HOUNDIGRADE_ECS_FAMILY_NAME}
        - name: INSPECT_PENDING_IMAGES_MIN_AGE
          value: ${INSPECT_PENDING_IMAGES_MIN_AGE}
        - name: INSPECT_PENDING_IMAGES_SCHEDULE
          value: ${INSPECT_PENDING_IMAGES_SCHEDULE}
        - name: INSPECTION_CLUSTER_INSTANCE_AGE_LIMIT
          value: ${INSPECTION_CLUSTER_INSTANCE_AGE_LIMIT}
        - name: HOUNDIGRADE_ECS_SCALE_UP_CLUSTER_SCHEDULE
          value: ${HOUNDIGRADE_ECS_SCALE_UP_CLUSTER_SCHEDULE}
        - name: HOUNDIGRADE_ECS_PERSIST_INSPECTION_RESULTS_SCHEDULE
          value: ${HOUNDIGRADE_ECS_PERSIST_INSPECTION_RESULTS_SCHEDULE}
        - name: AWS_REPOPULATE_EC2_INSTANCE_MAPPING_SCHEDULE
          value: ${AWS_REPOPULATE_EC2_INSTANCE_MAPPING_SCHEDULE}
        - name: CLOUDIGRADE_VERSION
          value: ${CLOUDIGRADE_VERSION}
        - name: CLOUDIGRADE_ENVIRONMENT
          value: ${CLOUDIGRADE_ENVIRONMENT}
        - name: SENTRY_TRACES_SAMPLE_RATE
          value: ${SENTRY_TRACES_SAMPLE_RATE}
        - name: CELERY_ENABLE_SENTRY
          value: ${CELERY_ENABLE_SENTRY}
        - name: CELERY_SENTRY_DSN
          value: ${CELERY_SENTRY_DSN}
        - name: CELERY_SENTRY_RELEASE
          value: ${CELERY_SENTRY_RELEASE}
        - name: CELERY_SENTRY_ENVIRONMENT
          value: ${CELERY_SENTRY_ENVIRONMENT}
        - name: LISTENER_TOPIC
          value: ${LISTENER_TOPIC}
        - name: LISTENER_GROUP_ID
          value: ${LISTENER_GROUP_ID}
        - name: LISTENER_SERVER
          value: ${LISTENER_SERVER}
        - name: LISTENER_PORT
          value: ${LISTENER_PORT}
        - name: SOURCES_ENABLE_DATA_MANAGEMENT_FROM_KAFKA
          value: ${SOURCES_ENABLE_DATA_MANAGEMENT_FROM_KAFKA}
        - name: SOURCES_API_BASE_URL
          value: ${SOURCES_API_BASE_URL}
        - name: CLOUDIGRADE_ENABLE_CLOUDWATCH
          value: ${CLOUDIGRADE_ENABLE_CLOUDWATCH}
        - name: CW_AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              key: aws_access_key_id
              name: cloudwatch
        - name: CW_AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: aws_secret_access_key
              name: cloudwatch
        - name: CW_AWS_REGION_NAME
          valueFrom:
            secretKeyRef:
              key: aws_region
              name: cloudwatch
        - name: CLOUDIGRADE_CW_LEVEL
          value: ${CLOUDIGRADE_CW_LEVEL}
        - name: CLOUDIGRADE_CW_LOG_GROUP
          valueFrom:
            secretKeyRef:
              key: log_group_name
              name: cloudwatch
        - name: CLOUDIGRADE_CW_STREAM_NAME
          value: ${CLOUDIGRADE_CW_STREAM_NAME}
        - name: OSD_REDEPLOY_TRIGGER
          value: ${OSD_REDEPLOY_TRIGGER}
        - name: IMAGE_TAG
          value: ${IMAGE_TAG}
        - name: HABERDASHER_EMITTER
          value: ${HABERDASHER_EMITTER}
        - name: HABERDASHER_KAFKA_BOOTSTRAP
          value: ${HABERDASHER_KAFKA_BOOTSTRAP}
        - name: HABERDASHER_KAFKA_TOPIC
          value: ${HABERDASHER_KAFKA_TOPIC}
        - name: HABERDASHER_LABELS
          value: ${HABERDASHER_LABELS}
        - name: HABERDASHER_TAGS
          value: ${HABERDASHER_TAGS}
        - name: VERBOSE_SOURCES_NOTIFICATION_LOGGING
          value: ${VERBOSE_SOURCES_NOTIFICATION_LOGGING}
        - name: CACHE_TTL_DEFAULT
          value: ${CACHE_TTL_DEFAULT}
        - name: CACHE_TTL_SOURCES_APPLICATION_TYPE_ID
          value: ${CACHE_TTL_SOURCES_APPLICATION_TYPE_ID}
        - name: WATCHTOWER_USE_QUEUES
          value: ${WATCHTOWER_USE_QUEUES}
        - name: WATCHTOWER_SEND_INTERVAL
          value: ${WATCHTOWER_SEND_INTERVAL}
        - name: WATCHTOWER_MAX_BATCH_COUNT
          value: ${WATCHTOWER_MAX_BATCH_COUNT}
        image: ' '
        imagePullPolicy: Always
        command:
          - /bin/sh
          - -c
          - >
            celery
            --app config
            worker
            --loglevel info
            --concurrency 1
            --task-events
            --queues celery,initial_aws_describe_instances,copy_ami_snapshot,copy_ami_to_customer_account,remove_snapshot_ownership,create_volume,enqueue_ready_volumes,delete_snapshot,inspect_pending_images,scale_up_inspection_cluster,attach_volumes_to_cluster,run_inspection_cluster,persist_inspection_cluster_results_task,scale_down_cluster,analyze_log,repopulate_ec2_instance_mapping,create_from_sources_kafka_message,configure_customer_aws_and_create_cloud_account,delete_from_sources_kafka_message,delete_inactive_users,delete_cloud_account,calculate_max_concurrent_usage,notify_application_availability_task,enable_account
        resources:
          requests:
            cpu: ${CELERY_WORKER_LIMITS_CONTAINER_CPU_REQUEST}
            memory: ${CELERY_WORKER_LIMITS_CONTAINER_MEM_REQUEST}
          limits:
            cpu: ${CELERY_WORKER_LIMITS_CONTAINER_CPU_LIMIT}
            memory: ${CELERY_WORKER_LIMITS_CONTAINER_MEM_LIMIT}
        livenessProbe:
          exec:
            command:
              - /bin/sh
              - -c
              - 'ps axo command | grep -v grep | grep python'
          failureThreshold: 3
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        readinessProbe:
          exec:
            command:
              - /bin/sh
              - -c
              - '[[ $(ps axo command | grep "[p]ython" | grep celery | grep -c worker) -eq 2 ]]'
          failureThreshold: 3
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
    database:
      name: cloudigrade 
parameters:
- name: APP_NAME
  displayName: Application Name
  description: Application name to be used in request paths. Only used when PATH_PREFIX is also specified.
  value: cloudigrade
- name: CLOWDER_ENABLED
  description: Determines Clowder deployment
  value: "True"
- name: ENCRYPTION_KEY
  displayName: Encryption Key (Ephemeral)
  required: true
  description: Encryption Key for Passwords
  from: "[a-zA-Z0-9]{43}"
  generate: expression
- name: ENV_NAME
  description: ClowdEnv Name
  required: true
- displayName: Health Check Host Header
  name: HEALTH_CHECK_HOST_HEADER
  required: true
  value: health.cloudigrade.insights.openshiftapps.com
- name: IMAGE
  displayName: Image
  description: Image name
  value: quay.io/abellott/cloudigrade
- name: IMAGE_TAG
  value: latest
- name: MIN_REPLICAS
  description: The number of replicas to use in the deployment
  value: "1"
- name: SECRET_KEY
  displayName: Secret Key (Ephemeral)
  required: true
  description: SECRET_KEY_BASE
  from: "[a-f0-9]{128}"
  generate: expression
#
# Component cloudigrade-api parameters:
#
- displayName: AWS Default Region
  name: AWS_DEFAULT_REGION
  required: true
  value: us-east-1
- displayName: AWS Houndigrade ECS Image Name
  name: HOUNDIGRADE_ECS_IMAGE_NAME
  required: true
  value: quay.io/cloudservices/houndigrade
- displayName: AWS Houndigrade ECS Image Tag
  name: HOUNDIGRADE_ECS_IMAGE_TAG
  required: true
  value: '0.6.3'
- displayName: AWS Houndigrade ECS Image Tag
  name: HOUNDIGRADE_ECS_FAMILY_NAME
  required: true
  value: Houndigrade
- displayName: AWS Houndigrade ECS Scale Up Cluster Schedule
  name: HOUNDIGRADE_ECS_SCALE_UP_CLUSTER_SCHEDULE
  required: true
  value: '300'
- displayName: AWS Houndigrade ECS Persist Inspection Results Schedule
  name: HOUNDIGRADE_ECS_PERSIST_INSPECTION_RESULTS_SCHEDULE
  required: true
  value: '120'
- displayName: AWS Repopulate EC2 Instance Mapping Schedule
  name: AWS_REPOPULATE_EC2_INSTANCE_MAPPING_SCHEDULE
  required: true
  value: '604800'
- displayName: AWS SQS Default Region
  name: AWS_SQS_REGION
  required: true
  value: us-east-1
- displayName: AWS SQS Max Receive Count
  name: AWS_SQS_MAX_RECEIVE_COUNT
  required: true
  value: '5'
- displayName: AWS SQS Max Yield Count
  name: AWS_SQS_MAX_YIELD_COUNT
  required: true
  value: '25'
- displayName: AWS SQS Max Houndigrade Yield Count
  name: AWS_SQS_MAX_HOUNDI_YIELD_COUNT
  required: true
  value: '10'
- displayName: AWS S3 Bucket Lifecycle Name
  name: AWS_S3_BUCKET_LC_NAME
  required: true
  value: s3_lifecycle_policy
- displayName: AWS S3 Bucket Lifecycle IA Transition
  name: AWS_S3_BUCKET_LC_IA_TRANSITION
  required: true
  value: '30'
- displayName: AWS S3 Bucket Lifecycle Glacier Transition
  name: AWS_S3_BUCKET_LC_GLACIER_TRANSITION
  required: true
  value: '60'
- displayName: AWS S3 Bucket Lifecycle Max Age
  name: AWS_S3_BUCKET_LC_MAX_AGE
  required: true
  value: '1460'
- displayName: ANALYZE_LOG Schedule
  name: ANALYZE_LOG_SCHEDULE
  required: true
  value: '30'
- displayName: Django Allowed Hosts
  name: DJANGO_ALLOWED_HOSTS
  required: true
  value: '*'
- displayName: Django Debug
  name: DJANGO_DEBUG
  required: true
  value: 'false'
- displayName: Django Log Level
  name: DJANGO_LOG_LEVEL
  required: true
  value: 'INFO'
- displayName: Django All Log Level
  name: DJANGO_ALL_LOG_LEVEL
  required: true
  value: 'INFO'
- displayName: Django Console Log Level
  name: DJANGO_CONSOLE_LOG_LEVEL
  required: true
  value: 'INFO'
- displayName: Cloudigrade Log Level
  name: CLOUDIGRADE_LOG_LEVEL
  required: true
  value: 'INFO'
- displayName: Django Settings Module
  name: DJANGO_SETTINGS_MODULE
  required: true
  value: config.settings.prod
- displayName: Sentry Performance Sample Rate
  name: SENTRY_TRACES_SAMPLE_RATE
  required: true
  value: '0.0'
- displayName: API Sentry Enabled (Str)
  name: API_SENTRY_ENABLED_STR
  required: true
  value: 'true'
- displayName: Celery Sentry Enabled (Str)
  name: CELERY_SENTRY_ENABLED_STR
  required: true
  value: 'true'
- displayName: Houndigrade Sentry Enabled (Str)
  name: HOUNDIGRADE_SENTRY_ENABLED_STR
  required: true
  value: 'true'
- displayName: Minimum age of images to inspect
  name: INSPECT_PENDING_IMAGES_MIN_AGE
  required: true
  value: '43200'
- displayName: Schedule to inspect pending images
  name: INSPECT_PENDING_IMAGES_SCHEDULE
  required: true
  value: '900'
- displayName: Inspection cluster instance age limit
  name: INSPECTION_CLUSTER_INSTANCE_AGE_LIMIT
  requires: true
  value: '600'
- displayName: Listener Log Level
  name: LISTENER_LOG_LEVEL
  required: true
  value: INFO
- displayName: Listener Topic
  name: LISTENER_TOPIC
  required: true
  value: platform.sources.event-stream
- displayName: Listerner Kafka Server Port
  name: LISTENER_PORT
  required: true
  value: '9092'
- displayName: Listener Enable Sentry
  name: LISTENER_ENABLE_SENTRY
  required: true
  value: 'true'
- displayName: Postigrade Port
  name: POSTIGRADE_PORT
  required: true
  value: '5432'
- displayName: Enable Data Management From Sources Kafka
  name: SOURCES_ENABLE_DATA_MANAGEMENT_FROM_KAFKA
  required: true
  value: 'true'
- displayName: Cloudigrade Replica Count
  name: API_REPLICA_COUNT
  required: true
  value: '4'
- displayName: Cloudigrade Max Replica Count
  name: API_REPLICA_COUNT_MAX
  required: true
  value: '8'
- displayName: Cloudigrade Target Average CPU Utilization
  name: API_TARGET_AVERAGE_CPU_UTILIZATION
  required: true
  value: '80'
- displayName: Cloudigrade Container CPU Request
  name: API_LIMITS_CONTAINER_CPU_REQUEST
  required: true
  value: 100m
- displayName: Cloudigrade Container Memory Request
  name: API_LIMITS_CONTAINER_MEM_REQUEST
  required: true
  value: 256Mi
- displayName: Cloudigrade Container CPU Limit
  name: API_LIMITS_CONTAINER_CPU_LIMIT
  required: true
  value: 200m
- displayName: Cloudigrade Container Memory Limit
  name: API_LIMITS_CONTAINER_MEM_LIMIT
  required: true
  value: 512Mi
- displayName: Health Check Host Header
  name: HEALTH_CHECK_HOST_HEADER
  required: true
  value: health.cloudigrade.insights.openshiftapps.com
- displayName: Cloudigrade Image tag
  name: IMAGE_TAG
  required: true
  value: latest
- displayName: SCHEDULE_CONCURRENT_USAGE_CALCULATION_DELAY
  name: SCHEDULE_CONCURRENT_USAGE_CALCULATION_DELAY
  required: true
  value: '1800'
- displayName: Verify Task Interval (seconds)
  name: SCHEDULE_VERIFY_VERIFY_TASKS_INTERVAL
  required: true
  value: '86400'
- name: HABERDASHER_EMITTER
  description: Emitter for haberdasher logs [stderr|kafka]
  value: kafka
- name: HABERDASHER_KAFKA_BOOTSTRAP
  description: Bootstrap server for haberdasher kafka emitter
  value: ''
- name: HABERDASHER_KAFKA_TOPIC
  description: Kafka topic for haberdasher kafka emitter
  value: 'platform.logging.logs'
- name: HABERDASHER_TAGS
  description: Haberdasher tags for unstrutured logs
  value: '["cloudigrade"]'
- name: HABERDASHER_LABELS
  description: Haberdasher labels for unstructured logs
  value: '{"app": "cloudigrade"}'
- name: CACHE_TTL_DEFAULT
  description: Default time to live in seconds for caches where specific ttl is not specified
  value: '60'
- name: CACHE_TTL_SOURCES_APPLICATION_TYPE_ID
  description: Time to live in seconds for sources application type id cache (overrides CACHE_TTL_DEFAULT)
  value: '60'
# The following parameters *generally* have different values in stage and prod.
# The default values provided here are correct for our stage environment.
- displayName: API Sentry Environment
  name: API_SENTRY_ENVIRONMENT
  required: true
  value: stage
- displayName: Celery Sentry Environment
  name: CELERY_SENTRY_ENVIRONMENT
  required: true
  value: stage
- displayName: Celery Sentry Release
  name: CELERY_SENTRY_RELEASE
  required: true
  value: stage
- displayName: Houndigrade Sentry Environment
  name: HOUNDIGRADE_SENTRY_ENVIRONMENT
  required: true
  value: stage
- displayName: Cloudigrade Commit Ref
  name: COMMIT_REF
  required: true
  value: stage
- displayName: Cloudigrade Environment
  name: CLOUDIGRADE_ENVIRONMENT
  required: true
  value: stage
- displayName: Listener Group ID
  name: LISTENER_GROUP_ID
  required: true
  value: cloudmeter_stage
- displayName: Listerner Kafka Server Address
  name: LISTENER_SERVER
  required: true
  value: platform-mq-stage-kafka-bootstrap.platform-mq-stage.svc
- displayName: Listener Sentry Environment
  name: LISTENER_SENTRY_ENVIRONMENT
  required: true
  value: stage
- displayName: Postigrade Host
  name: POSTIGRADE_HOST
  required: true
  value: postigrade.cloudigrade-stage.svc.cluster.local
- displayName: Sources API Base URL
  name: SOURCES_API_BASE_URL
  required: true
  value: http://sources-api.sources-stage.svc:8080
- displayName: Image namespace
  name: IMAGE_NAMESPACE
  required: true
  value: cloudigrade-stage
- displayName: Enable Cloudwatch
  name: CLOUDIGRADE_ENABLE_CLOUDWATCH
  required: true
  value: 'true'
- displayName: Cloudwatch Log Level
  name: CLOUDIGRADE_CW_LEVEL
  required: true
  value: 'INFO'
- displayName: Cloudwatch Stream Name.
  name: CLOUDIGRADE_CW_STREAM_NAME
  required: true
  value: cloudigrade-stage
- displayName: Enable verbose Insights identity header logging
  name: VERBOSE_INSIGHTS_IDENTITY_HEADER_LOGGING
  required: true
  value: 'false'
- displayName: Enable verbose sources notification logging
  name: VERBOSE_SOURCES_NOTIFICATION_LOGGING
  required: true
  value: 'false'
- displayName: Change this value to trigger OSD to redeploy
  name: OSD_REDEPLOY_TRIGGER
  required: true
  value: '1'
- displayName: The lifetime of a database connection, as an integer of seconds.
  name: DJANGO_DATABASE_CONN_MAX_AGE
  required: true
  value: '0'
- displayName: Watchtower use queues
  name: WATCHTOWER_USE_QUEUES
  required: true
  value: 'true'
- displayName: Watchtower send interval (seconds)
  name: WATCHTOWER_SEND_INTERVAL
  required: true
  value: '1.0'
- displayName: Watchtower max batch count
  name: WATCHTOWER_MAX_BATCH_COUNT
  required: true
  value: '1000'
#
# Component cloudigrade-beat parameters:
#
# The following parameters *generally* have the same values in stage and prod.
# The default values provided here are correct for our stage environment.
- displayName: Cloudigrade Replica Count
  name: CELERY_BEAT_REPLICA_COUNT
  required: true
  value: '1'
- displayName: Cloudigrade Celery Beat Container CPU Request
  name: CELERY_BEAT_LIMITS_CONTAINER_CPU_REQUEST
  required: true
  value: 100m
- displayName: Cloudigrade Celery Beat Container Memory Request
  name: CELERY_BEAT_LIMITS_CONTAINER_MEM_REQUEST
  required: true
  value: 100Mi
- displayName: Cloudigrade Celery Beat Container CPU Limit
  name: CELERY_BEAT_LIMITS_CONTAINER_CPU_LIMIT
  required: true
  value: 100m
- displayName: Cloudigrade Celery Beat Container Memory Limit
  name: CELERY_BEAT_LIMITS_CONTAINER_MEM_LIMIT
  required: true
  value: 128Mi
- displayName: Cloudigrade Image tag
  name: IMAGE_TAG
  required: true
  value: latest
- name: HABERDASHER_EMITTER
  description: Emitter for haberdasher logs [stderr|kafka]
  value: kafka
- name: HABERDASHER_KAFKA_BOOTSTRAP
  description: Bootstrap server for haberdasher kafka emitter
  value: ''
- name: HABERDASHER_KAFKA_TOPIC
  description: Kafka topic for haberdasher kafka emitter
  value: 'platform.logging.logs'
- name: HABERDASHER_TAGS
  description: Haberdasher tags for unstrutured logs
  value: '["cloudigrade"]'
- name: HABERDASHER_LABELS
  description: Haberdasher labels for unstructured logs
  value: '{"app": "cloudigrade"}'
- displayName: Watchtower use queues
  name: WATCHTOWER_USE_QUEUES
  required: true
  value: 'false'
- displayName: Watchtower send interval (seconds)
  name: WATCHTOWER_SEND_INTERVAL
  required: true
  value: '0.0'
- displayName: Watchtower max batch count
  name: WATCHTOWER_MAX_BATCH_COUNT
  required: true
  value: '1'
# The following parameters *generally* have different values in stage and prod.
# The default values provided here are correct for our stage environment.
- displayName: Image namespace
  name: IMAGE_NAMESPACE
  required: true
  value: cloudigrade-stage
#
# Component cloudigrade-listener parameters:
#
# The following parameters *generally* have the same values in stage and prod.
# The default values provided here are correct for our stage environment.
- displayName: Cloudigrade Listener Replica Count
  name: LISTENER_WORKER_REPLICA_COUNT
  required: true
  value: '1'
- displayName: Cloudigrade Listener Container CPU Request
  name: LISTENER_LIMITS_CONTAINER_CPU_REQUEST
  required: true
  value: 100m
- displayName: Cloudigrade Listener Container Memory Request
  name: LISTENER_LIMITS_CONTAINER_MEM_REQUEST
  required: true
  value: 128Mi
- displayName: Cloudigrade Listener Container CPU Limit
  name: LISTENER_LIMITS_CONTAINER_CPU_LIMIT
  required: true
  value: 200m
- displayName: Cloudigrade Listener Container Memory Limit
  name: LISTENER_LIMITS_CONTAINER_MEM_LIMIT
  required: true
  value: 256Mi
- displayName: Cloudigrade Listener Image tag
  name: IMAGE_TAG
  required: true
  value: latest
- name: HABERDASHER_EMITTER
  description: Emitter for haberdasher logs [stderr|kafka]
  value: kafka
- name: HABERDASHER_KAFKA_BOOTSTRAP
  description: Bootstrap server for haberdasher kafka emitter
  value: ''
- name: HABERDASHER_KAFKA_TOPIC
  description: Kafka topic for haberdasher kafka emitter
  value: 'platform.logging.logs'
- name: HABERDASHER_TAGS
  description: Haberdasher tags for unstrutured logs
  value: '["cloudigrade"]'
- name: HABERDASHER_LABELS
  description: Haberdasher labels for unstructured logs
  value: '{"app": "cloudigrade"}'
- displayName: Watchtower use queues
  name: WATCHTOWER_USE_QUEUES
  required: true
  value: 'false'
- displayName: Watchtower send interval (seconds)
  name: WATCHTOWER_SEND_INTERVAL
  required: true
  value: '0.0'
- displayName: Watchtower max batch count
  name: WATCHTOWER_MAX_BATCH_COUNT
  required: true
  value: '1'
# The following parameters *generally* have different values in stage and prod.
# The default values provided here are correct for our stage environment.
- displayName: Image namespace
  name: IMAGE_NAMESPACE
  required: true
  value: cloudigrade-stage
#
# Component cloudigrade-worker parameters:
#
# The following parameters *generally* have the same values in stage and prod.
# The default values provided here are correct for our stage environment.
- displayName: Cloudigrade Replica Count
  name: CELERY_WORKER_REPLICA_COUNT
  required: true
  value: '4'
- displayName: Cloudigrade Worker Replica Count Max
  name: CELERY_WORKER_REPLICA_COUNT_MAX
  required: true
  value: '8'
- displayName: Cloudigrade Worker Target Average CPU Utilization
  name: CELERY_TARGET_AVERAGE_CPU_UTILIZATION
  required: true
  value: '60'
- displayName: Cloudigrade Celery Worker Container CPU Request
  name: CELERY_WORKER_LIMITS_CONTAINER_CPU_REQUEST
  required: true
  value: 100m
- displayName: Cloudigrade Celery Worker Container Memory Request
  name: CELERY_WORKER_LIMITS_CONTAINER_MEM_REQUEST
  required: true
  value: 256Mi
- displayName: Cloudigrade Celery Worker Container CPU Limit
  name: CELERY_WORKER_LIMITS_CONTAINER_CPU_LIMIT
  required: true
  value: 200m
- displayName: Cloudigrade Celery Worker Container Memory Limit
  name: CELERY_WORKER_LIMITS_CONTAINER_MEM_LIMIT
  required: true
  value: 512Mi
- displayName: Cloudigrade Celery Image tag
  name: IMAGE_TAG
  required: true
  value: latest
- name: HABERDASHER_EMITTER
  description: Emitter for haberdasher logs [stderr|kafka]
  value: kafka
- name: HABERDASHER_KAFKA_BOOTSTRAP
  description: Bootstrap server for haberdasher kafka emitter
  value: ''
- name: HABERDASHER_KAFKA_TOPIC
  description: Kafka topic for haberdasher kafka emitter
  value: 'platform.logging.logs'
- name: HABERDASHER_TAGS
  description: Haberdasher tags for unstrutured logs
  value: '["cloudigrade"]'
- name: HABERDASHER_LABELS
  description: Haberdasher labels for unstructured logs
  value: '{"app": "cloudigrade"}'
- displayName: Watchtower use queues
  name: WATCHTOWER_USE_QUEUES
  required: true
  value: 'false'
- displayName: Watchtower send interval (seconds)
  name: WATCHTOWER_SEND_INTERVAL
  required: true
  value: '0.0'
- displayName: Watchtower max batch count
  name: WATCHTOWER_MAX_BATCH_COUNT
  required: true
  value: '1'
# The following parameters *generally* have different values in stage and prod.
# The default values provided here are correct for our stage environment.
- displayName: Image namespace
  name: IMAGE_NAMESPACE
  required: true
  value: cloudigrade-stage

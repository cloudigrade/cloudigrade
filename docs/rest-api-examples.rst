REST API Example Usage
======================

This document summarizes some examples of the cloudigrade REST API.

..
    This document can be regenerated by a developer using the following
    make target from the root directory of a sandbox environment having
    database ports forwarded locally:

    make docs-api-examples

Examples here use the ``http`` command from
`httpie <https://httpie.org/>`_. If you want to follow along with these
exact commands, you may need to ``brew install httpie`` or
``pip install httpie`` first.

These examples also assume you are running cloudigrade on
``localhost:8080`` and that you have correctly configured
cloudigradeâ€™s environment with appropriate variables to allow it to talk
to the various clouds (e.g. ``AWS_ACCESS_KEY_ID``).

Authentication
--------------

Most requests to cloudigrade's APIs require a custom HTTP header ``X-RH-IDENTITY`` that
describes the caller's identity. For Red Hat "consoledot" services, this header is
normally populated automatically by a 3scale gateway, but this document will populate
it by using an ``HTTP_X_RH_IDENTITY`` environment variable.

The ``X-RH-IDENTITY`` header's value must contain the base64-encoded JSON data like:


.. code:: json

    {
        "identity": {
            "account_number": "100001",
            "org_id": "200002"
        }
    }

.. code:: bash

    HTTP_X_RH_IDENTITY=eyJpZGVudGl0eSI6IHsiYWNjb3VudF9udW1iZXIiOiAiMTAwMDAxIiwgIm9yZ19pZCI6ICIyMDAwMDIifX0=

Some internal APIs may instead accept a combination of these custom HTTP headers:

* ``X-RH-CLOUDIGRADE-PSK`` contains a pre-shared key (secret)
* ``X-RH-CLOUDIGRADE-ACCOUNT-NUMBER`` contains the EBS account number for the user
* ``X-RH-CLOUDIGRADE-ORG-ID`` contains the consoledot org ID for the user

These three headers are not populated automatically by 3scale and must be explicitly
defined by the caller as needed. This document will populate them using the following
environment variables:

.. code:: bash

    HTTP_X_RH_CLOUDIGRADE_PSK=d4713d60-c8a7-4639-ab11-67b367a9c378
    HTTP_X_RH_CLOUDIGRADE_ACCOUNT_NUMBER=328046
    HTTP_X_RH_CLOUDIGRADE_ORG_ID=509748

Overview
--------

The following resource paths are currently available:

-  ``/api/cloudigrade/v2/accounts/`` returns accounts data
-  ``/api/cloudigrade/v2/sysconfig/`` returns sysconfig data
-  ``/api/cloudigrade/v2/azure-offer-template/`` returns azure offer template data


User Setup
------------------

Users are not typically created via interaction with the HTTP APIs.
When accessing any endpoint with the ``X-RH-IDENTITY`` header,
if the user found in the header does not exist, it will not be created,
but not all APIs require that a corresponding cloudigrade user exists.


Customer Account Info
---------------------

List all accounts
~~~~~~~~~~~~~~~~~

Request:

.. code:: bash

    http localhost:8080/api/cloudigrade/v2/accounts/ \
        "X-RH-IDENTITY:${HTTP_X_RH_IDENTITY}"

Response:

::

    HTTP/1.1 200 OK
    Allow: GET, HEAD, OPTIONS
    Content-Length: 1138
    Content-Type: application/json
    Cross-Origin-Opener-Policy: same-origin
    Referrer-Policy: same-origin
    X-CLOUDIGRADE-REQUEST-ID: e6d9af54-788f-495a-af50-9ca3e934f78d
    X-Content-Type-Options: nosniff
    X-Frame-Options: DENY

    {
        "data": [
            {
                "account_id": 1,
                "cloud_type": "aws",
                "content_object": {
                    "account_arn": "arn:aws:iam::116325369465:role/role-for-cloudigrade",
                    "aws_account_id": "116325369465",
                    "aws_cloud_account_id": 1,
                    "created_at": "2020-05-04T00:00:00Z",
                    "updated_at": "2020-05-18T13:51:59.722367Z"
                },
                "created_at": "2020-05-04T00:00:00Z",
                "is_enabled": true,
                "platform_application_id": 6890,
                "platform_application_is_paused": false,
                "platform_authentication_id": 6311,
                "platform_source_id": 663,
                "updated_at": "2020-05-18T13:51:59.722367Z",
                "user_id": 1
            },
            {
                "account_id": 2,
                "cloud_type": "azure",
                "content_object": {
                    "azure_cloud_account_id": 1,
                    "created_at": "2020-05-04T00:00:00Z",
                    "subscription_id": "9ecc40fc-e888-4bb4-8f9a-e6254f19ba12",
                    "updated_at": "2020-05-18T13:51:59.722367Z"
                },
                "created_at": "2020-05-04T00:00:00Z",
                "is_enabled": true,
                "platform_application_id": 8376,
                "platform_application_is_paused": false,
                "platform_authentication_id": 4242,
                "platform_source_id": 7961,
                "updated_at": "2020-05-18T13:51:59.722367Z",
                "user_id": 1
            }
        ],
        "links": {
            "first": "/api/cloudigrade/v2/accounts/?limit=10&offset=0",
            "last": "/api/cloudigrade/v2/accounts/?limit=10&offset=0",
            "next": null,
            "previous": null
        },
        "meta": {
            "count": 2
        }
    }


Retrieve a specific account
~~~~~~~~~~~~~~~~~~~~~~~~~~~

Request:

.. code:: bash

    http localhost:8080/api/cloudigrade/v2/accounts/1/ \
        "X-RH-IDENTITY:${HTTP_X_RH_IDENTITY}"

Response:

::

    HTTP/1.1 200 OK
    Allow: GET, HEAD, OPTIONS
    Content-Length: 496
    Content-Type: application/json
    Cross-Origin-Opener-Policy: same-origin
    Referrer-Policy: same-origin
    X-CLOUDIGRADE-REQUEST-ID: 0ec9ad28-d829-4787-801e-98eb71aa2c03
    X-Content-Type-Options: nosniff
    X-Frame-Options: DENY

    {
        "account_id": 1,
        "cloud_type": "aws",
        "content_object": {
            "account_arn": "arn:aws:iam::116325369465:role/role-for-cloudigrade",
            "aws_account_id": "116325369465",
            "aws_cloud_account_id": 1,
            "created_at": "2020-05-04T00:00:00Z",
            "updated_at": "2020-05-18T13:51:59.722367Z"
        },
        "created_at": "2020-05-04T00:00:00Z",
        "is_enabled": true,
        "platform_application_id": 6890,
        "platform_application_is_paused": false,
        "platform_authentication_id": 6311,
        "platform_source_id": 663,
        "updated_at": "2020-05-18T13:51:59.722367Z",
        "user_id": 1
    }


Miscellaneous Commands
----------------------

Retrieve current publicly-viewable system configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The sysconfig endpoint includes the AWS cloud account id used by the application, AWS policies used for acting on behalf of customers, and the currently deployed backend version.

Request:

.. code:: bash

    http localhost:8080/api/cloudigrade/v2/sysconfig/ \
        "X-RH-IDENTITY:${HTTP_X_RH_IDENTITY}"

Response:

::

    HTTP/1.1 200 OK
    Allow: GET, HEAD, OPTIONS
    Content-Length: 680
    Content-Type: application/json
    Cross-Origin-Opener-Policy: same-origin
    Referrer-Policy: same-origin
    X-CLOUDIGRADE-REQUEST-ID: 78ae68e6-91df-42ea-8fa6-5b63d6a84027
    X-Content-Type-Options: nosniff
    X-Frame-Options: DENY

    {
        "aws_account_id": 991758150271,
        "aws_policies": {
            "traditional_inspection": {
                "Statement": [
                    {
                        "Action": [
                            "ec2:DescribeImages",
                            "ec2:DescribeInstances",
                            "ec2:ModifySnapshotAttribute",
                            "ec2:DescribeSnapshotAttribute",
                            "ec2:DescribeSnapshots",
                            "ec2:CopyImage",
                            "ec2:CreateTags",
                            "ec2:DescribeRegions",
                            "cloudtrail:CreateTrail",
                            "cloudtrail:UpdateTrail",
                            "cloudtrail:PutEventSelectors",
                            "cloudtrail:DescribeTrails",
                            "cloudtrail:StartLogging",
                            "cloudtrail:DeleteTrail"
                        ],
                        "Effect": "Allow",
                        "Resource": "*",
                        "Sid": "CloudigradePolicy"
                    }
                ],
                "Version": "2012-10-17"
            }
        },
        "azure_offer_template_path": "/api/cloudigrade/v2/azure-offer-template/",
        "version": "489-cloudigrade-version - d2b30c637ce3788e22990b21434bac2edcfb7ede"
    }

Retrieve anonymously viewable Azure Offer Template
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The Azure Offer Template endpoint returns a json template populated with current running data, to be consumed by Azure to grant cloudigrade access to the customers account.

Request:

.. code:: bash

    http localhost:8080/api/cloudigrade/v2/azure-offer-template/

Response:

::

    HTTP/1.1 200 OK
    Access-Control-Allow-Origin: *
    Allow: GET, HEAD, OPTIONS
    Content-Length: 2357
    Content-Type: application/json
    Cross-Origin-Opener-Policy: same-origin
    Referrer-Policy: same-origin
    X-CLOUDIGRADE-REQUEST-ID: fc0366f3-ad6a-4000-b603-b7c100fad2ac
    X-Content-Type-Options: nosniff
    X-Frame-Options: DENY

    {
        "$schema": "https://schema.management.azure.com/schemas/2019-08-01/subscriptionDeploymentTemplate.json#",
        "contentVersion": "1.0.0.0",
        "outputs": {
            "authorizations": {
                "type": "array",
                "value": "[parameters('authorizations')]"
            },
            "mspOfferName": {
                "type": "string",
                "value": "[concat('Managed by', ' ', parameters('mspOfferName'))]"
            }
        },
        "parameters": {
            "authorizations": {
                "allowedValues": [
                    [
                        {
                            "principalId": "691f0b3e-exam-ple3-b03f-6eb5120acabb",
                            "principalIdDisplayName": "cloudigrade-rest-api-examples",
                            "roleDefinitionId": "acdd72a7-3385-48ef-bd42-f606fba81ae7"
                        },
                        {
                            "principalId": "691f0b3e-exam-ple3-b03f-6eb5120acabb",
                            "principalIdDisplayName": "cloudigrade-rest-api-examples",
                            "roleDefinitionId": "91c1777a-f3dc-4fae-b103-61d183457e46"
                        }
                    ]
                ],
                "defaultValue": [
                    {
                        "principalId": "691f0b3e-exam-ple3-b03f-6eb5120acabb",
                        "principalIdDisplayName": "cloudigrade-rest-api-examples",
                        "roleDefinitionId": "acdd72a7-3385-48ef-bd42-f606fba81ae7"
                    },
                    {
                        "principalId": "691f0b3e-exam-ple3-b03f-6eb5120acabb",
                        "principalIdDisplayName": "cloudigrade-rest-api-examples",
                        "roleDefinitionId": "91c1777a-f3dc-4fae-b103-61d183457e46"
                    }
                ],
                "type": "array"
            },
            "managedByTenantId": {
                "allowedValues": [
                    "81329282-exam-ple3-80af-f6457b5b32ad"
                ],
                "defaultValue": "81329282-exam-ple3-80af-f6457b5b32ad",
                "type": "string"
            },
            "mspOfferDescription": {
                "allowedValues": [
                    ""
                ],
                "defaultValue": "",
                "type": "string"
            },
            "mspOfferName": {
                "allowedValues": [
                    "cloudigrade-rest-api-examples"
                ],
                "defaultValue": "cloudigrade-rest-api-examples",
                "type": "string"
            }
        },
        "resources": [
            {
                "apiVersion": "2020-02-01-preview",
                "name": "[variables('mspRegistrationName')]",
                "properties": {
                    "authorizations": "[parameters('authorizations')]",
                    "description": "[parameters('mspOfferDescription')]",
                    "managedByTenantId": "[parameters('managedByTenantId')]",
                    "registrationDefinitionName": "[parameters('mspOfferName')]"
                },
                "type": "Microsoft.ManagedServices/registrationDefinitions"
            },
            {
                "apiVersion": "2020-02-01-preview",
                "dependsOn": [
                    "[resourceId('Microsoft.ManagedServices/registrationDefinitions/', variables('mspRegistrationName'))]"
                ],
                "name": "[variables('mspAssignmentName')]",
                "properties": {
                    "registrationDefinitionId": "[resourceId('Microsoft.ManagedServices/registrationDefinitions/', variables('mspRegistrationName'))]"
                },
                "type": "Microsoft.ManagedServices/registrationAssignments"
            }
        ],
        "variables": {
            "mspAssignmentName": "[guid(parameters('mspOfferName'))]",
            "mspRegistrationName": "[guid(parameters('mspOfferName'))]"
        }
    }


Internal APIs
-------------

The following APIs are only available internally and are not fully supported.
Caveat emptor. Hic sunt dracones.


Create an AWS account
~~~~~~~~~~~~~~~~~~~~~

This request may take a few seconds because of multiple round-trip calls
to the AWS APIs for each region. The "name" attribute is required and has a
maximum supported length of 256 characters. The "platform_authentication_id",
"platform_application_id", "platform_endpoint_id", and "platform_source_id"
attributes are all required and should be integers.

Request:

.. code:: bash

    http post localhost:8080/internal/api/cloudigrade/v1/accounts/ \
        "X-RH-IDENTITY:${HTTP_X_RH_IDENTITY}" \
        cloud_type="aws" \
        account_arn="arn:aws:iam::768322003703:role/role-for-cloudigrade" \
        platform_authentication_id="5866" \
        platform_application_id="9558" \
        platform_source_id="3578"

Response:

::

    HTTP/1.1 201 Created
    Allow: GET, POST, HEAD, OPTIONS
    Content-Length: 511
    Content-Type: application/json
    Cross-Origin-Opener-Policy: same-origin
    Referrer-Policy: same-origin
    X-CLOUDIGRADE-REQUEST-ID: bd1455bd-0b8b-4722-bdc3-f47b5a9c49ac
    X-Content-Type-Options: nosniff
    X-Frame-Options: DENY

    {
        "account_id": 3,
        "cloud_type": "aws",
        "content_object": {
            "account_arn": "arn:aws:iam::768322003703:role/role-for-cloudigrade",
            "aws_account_id": "768322003703",
            "aws_cloud_account_id": 2,
            "created_at": "2020-05-18T13:51:59.722367Z",
            "updated_at": "2020-05-18T13:51:59.722367Z"
        },
        "created_at": "2020-05-18T13:51:59.722367Z",
        "is_enabled": true,
        "platform_application_id": 9558,
        "platform_application_is_paused": false,
        "platform_authentication_id": 5866,
        "platform_source_id": 3578,
        "updated_at": "2020-05-18T13:51:59.722367Z",
        "user_id": 1
    }

If you attempt to create an AWS account for an ARN that is already in
the system, you should get a 400 error.

Request:

.. code:: bash

    http post localhost:8080/internal/api/cloudigrade/v1/accounts/ \
        "X-RH-IDENTITY:${HTTP_X_RH_IDENTITY}" \
        cloud_type="aws" \
        account_arn="arn:aws:iam::768322003703:role/role-for-cloudigrade" \
        platform_authentication_id="8268" \
        platform_application_id="2281" \
        platform_source_id="4617"

Response:

::

    HTTP/1.1 400 Bad Request
    Allow: GET, POST, HEAD, OPTIONS
    Content-Length: 157
    Content-Type: application/json
    Cross-Origin-Opener-Policy: same-origin
    Referrer-Policy: same-origin
    X-CLOUDIGRADE-REQUEST-ID: f2e4a2da-9e21-474f-a3bf-6ad4a6140098
    X-Content-Type-Options: nosniff
    X-Frame-Options: DENY

    {
        "account_arn": "Could not enable cloud metering. Error code CG1001. AWS ARN must be unique, but another cloud account with the same AWS ARN already exists."
    }


Create an Azure account
~~~~~~~~~~~~~~~~~~~~~
The "name" attribute is required and has a maximum supported length of 256 characters.
The "platform_authentication_id", "platform_application_id", "platform_endpoint_id",
and "platform_source_id" attributes are all required and should be integers.

Request:

.. code:: bash

    http post localhost:8080/internal/api/cloudigrade/v1/accounts/ \
        "X-RH-IDENTITY:${HTTP_X_RH_IDENTITY}" \
        cloud_type="azure" \
        subscription_id="31b25528-3d39-4372-a0b5-e0ac91df6a08" \
        platform_authentication_id="2289" \
        platform_application_id="1553" \
        platform_source_id="4104"

Response:

::

    HTTP/1.1 201 Created
    Allow: GET, POST, HEAD, OPTIONS
    Content-Length: 472
    Content-Type: application/json
    Cross-Origin-Opener-Policy: same-origin
    Referrer-Policy: same-origin
    X-CLOUDIGRADE-REQUEST-ID: 87e27ce8-8f9a-4100-a209-7e534fd6770c
    X-Content-Type-Options: nosniff
    X-Frame-Options: DENY

    {
        "account_id": 4,
        "cloud_type": "azure",
        "content_object": {
            "azure_cloud_account_id": 2,
            "created_at": "2020-05-18T13:51:59.722367Z",
            "subscription_id": "31b25528-3d39-4372-a0b5-e0ac91df6a08",
            "updated_at": "2020-05-18T13:51:59.722367Z"
        },
        "created_at": "2020-05-18T13:51:59.722367Z",
        "is_enabled": true,
        "platform_application_id": 1553,
        "platform_application_is_paused": false,
        "platform_authentication_id": 2289,
        "platform_source_id": 4104,
        "updated_at": "2020-05-18T13:51:59.722367Z",
        "user_id": 1
    }


Search for a user
~~~~~~~~~~~~~~~~~

To search for and retrieve a user, you may filter using "account_number", "username"
(which simply maps to the account_number for backward compatibility), or "org_id".

Request:

.. code:: bash

    http localhost:8080/internal/api/cloudigrade/v1/users/ \
        "X-RH-CLOUDIGRADE-PSK:${HTTP_X_RH_CLOUDIGRADE_PSK}" \
        account_number=="100001"


::

    HTTP/1.1 200 OK
    Allow: GET, POST, HEAD, OPTIONS
    Content-Length: 415
    Content-Type: application/json
    Cross-Origin-Opener-Policy: same-origin
    Referrer-Policy: same-origin
    X-CLOUDIGRADE-REQUEST-ID: cfd2e0f9-cf6a-408c-bff6-a2fa15d6b921
    X-Content-Type-Options: nosniff
    X-Frame-Options: DENY

    {
        "data": [
            {
                "account_number": "100001",
                "date_joined": "2019-01-01T00:00:00Z",
                "id": 1,
                "is_permanent": false,
                "org_id": "200002",
                "username": "100001",
                "uuid": "d862c2e3-6b0a-42f7-827c-67ebc8d44df7"
            }
        ],
        "links": {
            "first": "/internal/api/cloudigrade/v1/users/?account_number=100001&limit=10&offset=0",
            "last": "/internal/api/cloudigrade/v1/users/?account_number=100001&limit=10&offset=0",
            "next": null,
            "previous": null
        },
        "meta": {
            "count": 1
        }
    }

REST API Example Usage
======================

This document summarizes some examples of the cloudigrade REST API.

..
    This document can be regenerated by a developer using the following
    make target from the root directory of a sandbox environment having
    database ports forwarded locally:

    make docs-api-examples

Examples here use the ``http`` command from
`httpie <https://httpie.org/>`_. If you want to follow along with these
exact commands, you may need to ``brew install httpie`` or
``pip install httpie`` first.

These examples also assume you are running cloudigrade on
``localhost:8080`` and that you have correctly configured
cloudigradeâ€™s environment with appropriate variables to allow it to talk
to the various clouds (e.g. ``AWS_ACCESS_KEY_ID``).

Authentication
--------------

Most requests to cloudigrade's APIs require a custom HTTP header ``X-RH-IDENTITY`` that
describes the caller's identity. For Red Hat "consoledot" services, this header is
normally populated automatically by a 3scale gateway, but this document will populate
it by using an ``HTTP_X_RH_IDENTITY`` environment variable.

The ``X-RH-IDENTITY`` header's value must contain the base64-encoded JSON data like:


{{ v2_rh_identity | tojson(indent=4) | rst_codeblock("json") }}

.. code:: bash

    HTTP_X_RH_IDENTITY={{v2_header}}

Some internal APIs may instead accept a combination of these custom HTTP headers:

* ``X-RH-CLOUDIGRADE-PSK`` contains a pre-shared key (secret)
* ``X-RH-CLOUDIGRADE-ACCOUNT-NUMBER`` contains the EBS account number for the user
* ``X-RH-CLOUDIGRADE-ORG-ID`` contains the consoledot org ID for the user

These three headers are not populated automatically by 3scale and must be explicitly
defined by the caller as needed. This document will populate them using the following
environment variables:

.. code:: bash

    HTTP_X_RH_CLOUDIGRADE_PSK={{internal_psk}}
    HTTP_X_RH_CLOUDIGRADE_ACCOUNT_NUMBER={{internal_account_number}}
    HTTP_X_RH_CLOUDIGRADE_ORG_ID={{internal_org_id}}

Overview
--------

The following resource paths are currently available:

-  ``/api/cloudigrade/v2/accounts/`` returns accounts data
-  ``/api/cloudigrade/v2/instances/`` returns instances data
-  ``/api/cloudigrade/v2/images/`` returns images data
-  ``/api/cloudigrade/v2/sysconfig/`` returns sysconfig data
-  ``/api/cloudigrade/v2/azure-offer-template/`` returns azure offer template data


User Setup
------------------

Users are not typically created via interaction with the HTTP APIs.
When accessing any endpoint with the ``X-RH-IDENTITY`` header,
if the user found in the header does not exist, it will not be created,
but not all APIs require that a corresponding cloudigrade user exists.


Customer Account Info
---------------------

List all accounts
~~~~~~~~~~~~~~~~~

Request:

{{ v2_account_list.wsgi_request | httpied_command() | rst_codeblock("bash") }}

Response:

{{ v2_account_list | stringify_http_response | rst_codeblock }}


Retrieve a specific account
~~~~~~~~~~~~~~~~~~~~~~~~~~~

Request:

{{ v2_account_get.wsgi_request | httpied_command() | rst_codeblock("bash") }}

Response:

{{ v2_account_get | stringify_http_response | rst_codeblock }}


Instance Info
-------------

List all instances
~~~~~~~~~~~~~~~~~~

Request:

{{ v2_instance_list.wsgi_request | httpied_command() | rst_codeblock("bash") }}

Response:

{{ v2_instance_list | stringify_http_response | rst_codeblock }}


Retrieve a specific instance
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Request:

{{ v2_instance_get.wsgi_request | httpied_command() | rst_codeblock("bash") }}

Response:

{{ v2_instance_get | stringify_http_response | rst_codeblock }}


Filtering instances
~~~~~~~~~~~~~~~~~~~

You may also include an optional "running_since" query string argument to filter for only
instances that have been running uninterrupted since the given time.

Request:

{{ v2_instance_filter_running.wsgi_request | httpied_command() | rst_codeblock("bash") }}

Response:

{{ v2_instance_filter_running | stringify_http_response | rst_codeblock }}


Machine Images
--------------

List all images
~~~~~~~~~~~~~~~

Below command will return all images that have been seen used by any instance for any account belonging to the user that makes the request.

Request:

{{ v2_list_images.wsgi_request | httpied_command() | rst_codeblock("bash") }}

Response:

{{ v2_list_images | stringify_http_response | rst_codeblock }}


Retrieve a specific image
~~~~~~~~~~~~~~~~~~~~~~~~~

Request:

{{ v2_get_image.wsgi_request | httpied_command() | rst_codeblock("bash") }}

Response:

{{ v2_get_image | stringify_http_response | rst_codeblock }}


Miscellaneous Commands
----------------------

Retrieve current publicly-viewable system configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The sysconfig endpoint includes the AWS cloud account id used by the application, AWS policies used for acting on behalf of customers, and the currently deployed backend version.

Request:

{{ v2_get_sysconfig.wsgi_request | httpied_command() | rst_codeblock("bash") }}

Response:

{{ v2_get_sysconfig | stringify_http_response | rst_codeblock }}

Retrieve anonymously viewable Azure Offer Template
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The Azure Offer Template endpoint returns a json template populated with current running data, to be consumed by Azure to grant cloudigrade access to the customers account.

Request:

{{ v2_get_azure_offer.wsgi_request | httpied_command() | rst_codeblock("bash") }}

Response:

{{ v2_get_azure_offer | stringify_http_response | rst_codeblock }}


Internal APIs
-------------

The following APIs are only available internally and are not fully supported.
Caveat emptor. Hic sunt dracones.


Create an AWS account
~~~~~~~~~~~~~~~~~~~~~

This request may take a few seconds because of multiple round-trip calls
to the AWS APIs for each region. The "name" attribute is required and has a
maximum supported length of 256 characters. The "platform_authentication_id",
"platform_application_id", "platform_endpoint_id", and "platform_source_id"
attributes are all required and should be integers.

Request:

{{ internal_account_create_aws.wsgi_request | httpied_command() | rst_codeblock("bash") }}

Response:

{{ internal_account_create_aws | stringify_http_response | rst_codeblock }}

If you attempt to create an AWS account for an ARN that is already in
the system, you should get a 400 error.

Request:

{{ internal_account_create_aws_duplicate_arn.wsgi_request | httpied_command() | rst_codeblock("bash") }}

Response:

{{ internal_account_create_aws_duplicate_arn | stringify_http_response | rst_codeblock }}


Create an Azure account
~~~~~~~~~~~~~~~~~~~~~
The "name" attribute is required and has a maximum supported length of 256 characters.
The "platform_authentication_id", "platform_application_id", "platform_endpoint_id",
and "platform_source_id" attributes are all required and should be integers.

Request:

{{ internal_account_create_azure.wsgi_request | httpied_command() | rst_codeblock("bash") }}

Response:

{{ internal_account_create_azure | stringify_http_response | rst_codeblock }}


Search for a user
~~~~~~~~~~~~~~~~~

To search for and retrieve a user, you may filter using "account_number", "username"
(which simply maps to the account_number for backward compatibility), or "org_id".

Request:

{{ internal_user_list_filtered_by_account_number.wsgi_request |  httpied_command() | rst_codeblock("bash") }}


{{ internal_user_list_filtered_by_account_number | stringify_http_response | rst_codeblock }}
